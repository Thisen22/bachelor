---
title: "Goal! replikation"
output: html_document
date: "2025-03-28"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Dataformatering
```{r}
library(readxl)
library(dplyr)
library(plm)
library(lmtest)
data <- read_excel("data.xlsx", range = "A1:G261")

#Formatering af lavet ud fra den i GOAL!
df <- data %>%
  group_by(season) %>%
  mutate(log_revenue = log(revenue / mean(revenue))) %>% 
  mutate(log_wage = log(wage / mean(wage))) %>%
  mutate(log_point = log(points / (114+1-points))) %>% # i stedet for placering anvendes point, der plusses med 1 for at undgå division med 0 (selvom ingen klubber har fået 114 eller 0 point i PL nogensinde, men sikrer sig mod, hvis det skulle ske og kode/metode skal genanvendes til det)
  mutate(log_rank = log((20+1-placering) / placering)) %>% # GOAL!'s variable for præstation
  
  ungroup()

#laver sæson til numerisk tal 10_11 -> 2010
df$season_numeric <- as.numeric(sub("_.*", "", df$season))
df$season_numeric <- ifelse(df$season_numeric < 50, df$season_numeric + 2000, df$season_numeric + 1900)

df$club   <- as.factor(df$club)


# Tæller antal sæsoner pr- klub
valid_clubs <- df %>%
  group_by(club) %>%
  summarise(n_seasons = n()) %>%
  filter(n_seasons >= 7) %>% #minimum 7 sæsoner
  pull(club)

# Filtrer datasættet
data_filtered <- df %>%
  filter(club %in% valid_clubs)

# Lav paneldataframe
pdata <- pdata.frame(df, index = c("club", "season_numeric")) 

# Lav pdata.frame for filtreret data
data_filtered <- pdata.frame(data_filtered, index = c("club", "season_numeric"))

```

## Test af RE eller FE
### Point
```{r}
fe_model_points <- plm(log_point ~ log_wage + lag(log_point, 1), data = data_filtered,
  model = "within"  # eller "pooling", "random", etc. afhængigt af hvad du laver
)
re_model_points <- plm(log_point ~ log_wage + lag(log_point, 1), data = data_filtered,
  model = "random"  # eller "pooling", "random", etc. afhængigt af hvad du laver
)

hausman_test <- phtest(fe_model_points, re_model_points)
print(hausman_test)

ols_model <- plm(log_point ~ log_wage + lag(log_point, 1), data = data_filtered, model = "pooling")


# FE eller OLS?
pFtest(fe_model_points, ols_model)
```

### Revenue
```{r}
fe_model_revenue <- plm(
  log_revenue ~ log_point + lag(log_revenue, 1),
  data = data_filtered,
  model = "within"  # eller "pooling", "random", etc. afhængigt af hvad du laver
)
re_model_revenue <- plm(
  log_revenue ~ log_point + lag(log_revenue, 1),
  data = data_filtered,
  model = "random"  # eller "pooling", "random", etc. afhængigt af hvad du laver
)

hausman_test_revenue <- phtest(fe_model_revenue, re_model_revenue)
print(hausman_test_revenue)
```


## Revenue regression
### For alle holdene i datasættet:
```{r}
plm_model <- plm(
  log_revenue ~ log_point + lag(log_revenue, 1),
  data = pdata,
  model = "within"  # eller "pooling", "random", etc. afhængigt af hvad du laver
)

summary(plm_model)
```

### Filtreret datasæt
```{r}

plm_model_filtered <- plm(
  log_revenue ~ log_point + lag(log_revenue, 1),
  data = data_filtered,
  model = "within"  # eller "pooling", "random", etc. afhængigt af hvad du laver
)

summary(plm_model_filtered)
fixef(plm_model_filtered,
      type = c("dmean"))
within_intercept(plm_model_filtered)

pbgtest(plm_model_filtered)
pwartest(plm_model_filtered)
pcdtest(plm_model_filtered, test = "cd")
#resettest(plm_model_filtered) kan ikke køres

coeftest(plm_model_filtered, vcov = vcovHC(plm_model_filtered, type = "HC1", cluster = "group"))
```

## Performance regression
### For alle holdene i datasættet:
```{r}
perform_model <- plm(
  log_point ~ log_wage + lag(log_point, 1),
  data = pdata,
  model = "within"  # eller "pooling", "random", etc. afhængigt af hvad du laver
)

summary(perform_model)
```

### Filtreret datasæt
```{r}
perform_model_filtered <- plm(
  log_point ~ log_wage,
  data = data_filtered,
  model = "within"  # eller "pooling", "random", etc. afhængigt af hvad du laver
)

summary(perform_model_filtered)
fixef(perform_model_filtered)

pbgtest(perform_model_filtered)
pwartest(perform_model_filtered)
pcdtest(perform_model_filtered, test = "cd")
```

## Win-maximization
$$P_{it}^*=\frac{21}{1+exp(\frac{a+b_i+c(\alpha+\beta_i)+c\;ln\bar{R_t}-c\;ln\bar{W_t}}{c\gamma-1})}$$

## Profit-maximization
$$P_{it}^*=\frac{21}{1+exp(\frac{a+b_i+c(\alpha+\beta_i)+c\;ln\bar{R_t}-c\;ln\bar{W_t}+c\;ln(c\gamma)}{c\gamma-1})}$$

##forsøg på at replikere manchester uniteds positioner i paper
```{r}
beta <- 0.7476
b <- 1.4442
a <- -0.4145
alpha <- -0.945
gamma <- 0.2274
c <- 1.2581
R <- 25860.75
W <- 16165.880
#profit
45 / (1+exp((a + b + c * (alpha+beta) + c * log(R) - c * log(W) + c * log(c*gamma) ) / (c*gamma -1) ))

#win
45 / (1+exp((a + b + c * (alpha+beta) + c * log(R) - c * log(W)) /(c*gamma -1) ))
```


